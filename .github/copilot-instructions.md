# 前提条件

## 基本ルール

- 回答は必ず日本語でしてください
- 大規模な変更（例: 200 行以上）を行う前には、まず変更計画を提案してください
- エラーメッセージや例外が発生した場合は、日本語で説明してください
- コードを生成する際は、必ず既存のコードスタイルに合わせてください
- 新しいライブラリを導入する前には、必ず確認してください

## コミュニケーション

- 質問や不明点がある場合は、必ず確認してください
- 複数の解決策がある場合は、それぞれの長所と短所を説明してください

# アプリの概要

## プロジェクト目的

このプロジェクトは「Works Logue」という Next.js ベースの Web アプリケーションで、TypeScript を使用して開発されています。記事投稿やユーザー認証機能を持つブログ系プラットフォームです。

## 主要な技術要素

- **Frontend**: Next.js 15.5.9 (App Router)、React 19、TypeScript
- **Backend**: Next.js API Routes、NextAuth.js v5
- **Database**: PostgreSQL、Prisma ORM
- **Styling**: Tailwind CSS、shadcn/ui、Radix UI
- **認証**: NextAuth.js、bcryptjs
- **バリデーション**: Zod
- **フォーム管理**: React Hook Form

## プロジェクトの特徴

- モダンな Next.js App Router を使用したフルスタック構成
- Prisma による型安全なデータベース操作
- shadcn/ui による統一された UI コンポーネント
- NextAuth.js によるセキュアな認証システム
- TypeScript による型安全性の確保

# 技術スタック（エコシステム）

## 使用技術

**言語**: TypeScript、JavaScript
**フレームワーク**: Next.js 15.5.9 (App Router)
**ランタイム**: React 19、Node.js
**パッケージマネージャー**: npm
**データベース**: PostgreSQL
**ORM**: Prisma 6.19.1
**認証**: NextAuth.js 5.0.0-beta.30
**スタイリング**: Tailwind CSS 4、shadcn/ui
**バリデーション**: Zod
**フォーム**: React Hook Form
**UI ライブラリ**: Radix UI
**アイコン**: Lucide React
**マークダウン**: react-markdown、rehype
**暗号化**: bcryptjs
**日付**: date-fns
**リンター**: ESLint 9

## 重要事項

- プロジェクトで使用されていないライブラリは import しないでください
- 既存のバージョンに合わせてライブラリを使用してください
- 新しい依存関係を追加する際は、互換性を確認してください
- データベーススキーマの変更は Prisma マイグレーションファイルで管理してください
- Prisma のベストプラクティスに従ってください
- Next.js App Router の規約に従ってファイルを配置してください
- 認証には NextAuth.js v5 を使用し、Credentials プロバイダーを活用してください

# ディレクトリ構成

## 主要ディレクトリ

- **`src/app/`**: Next.js App Router のページとレイアウト
  - **`(auth)/`**: 認証関連のページグループ
  - **`(public)/`**: パブリックページグループ
  - **`api/`**: Next.js API Routes
- **`src/shared/`**: 共有コンポーネントとユーティリティ
  - **`lib/`**: ライブラリとユーティリティ関数
  - **`ui/`**: UI コンポーネント（shadcn/ui 含む）
- **`src/views/`**: ページレベルのビューコンポーネント
- **`prisma/`**: Prisma スキーマとマイグレーション
- **`public/`**: 静的ファイル

## ファイル配置ルール

- 新しいページは `src/app/` 内の適切なルートグループに配置してください
- 共通コンポーネントは `src/shared/ui/` に配置してください
- ビジネスロジックは `src/shared/lib/actions/` に配置してください
- 型定義は適切なファイルの近くに配置するか、`src/shared/types/` に配置してください
- shadcn/ui コンポーネントは `src/shared/ui/shadcn/` に配置してください

# アーキテクチャ・設計指針

## 採用している設計パターン

- **Next.js App Router**: ファイルベースルーティング
- **Component-Based Architecture**: UI コンポーネントの再利用
- **Server Actions**: サーバーサイド処理とクライアントサイド処理の分離
- **Layered Architecture**: UI 層、ビジネスロジック層、データアクセス層の分離
- **Route Groups**: 論理的なページグループ化（auth、public）
- **Feature-Sliced Design (FSD)**: フロントエンドアプリケーションの体系的な設計方法論

## FSD（Feature-Sliced Design）設計原則

このプロジェクトでは、FSD の設計原則に従ってコードを整理してください。

### レイヤー構造（下位から上位へ）

1. **Shared** (`src/shared/`) - 再利用可能なコード、外部との接続

   - `ui/` - UI キット、ビジネスロジックを含まないコンポーネント
   - `lib/` - ライブラリ、ヘルパー関数（焦点を持った内部ライブラリ）
   - `api/` - API クライアント、バックエンドとのやり取り
   - `config/` - 環境変数、グローバル設定

2. **Entities** (`src/entities/`) - ビジネスエンティティ

   - `user/`, `article/`, `topic/` など
   - 各エンティティは独立したスライスとして構成

3. **Features** (`src/features/`) - ユーザーアクション、再利用可能な機能

   - `auth/`, `article-editor/`, `comment-system/` など
   - 複数ページで使用される機能

4. **Widgets** (`src/widgets/`) - 大きな自己完結型 UI ブロック

   - `header/`, `sidebar/`, `article-card/` など

5. **Pages** (`src/pages/`) - ページ全体またはページの大部分

   - `home/`, `profile/`, `article-detail/` など

6. **App** (`src/app/`) - アプリケーション起動に関するすべて
   - `routes/` - ルーター設定
   - `store/` - グローバルストア
   - `styles/` - グローバルスタイル

### セグメント構造（各スライス内の技術的分割）

- **ui** - UI コンポーネント、表示関連
- **api** - バックエンドとのやり取り、リクエスト関数
- **model** - データモデル、バリデーション、ビジネスロジック
- **lib** - スライス固有のライブラリコード
- **config** - 設定ファイル、フィーチャーフラグ

### インポートルール

- **レイヤー間**: 上位レイヤーから下位レイヤーのみインポート可能
- **スライス間**: 同一レイヤー内のスライス間のインポートは禁止
- **公開 API**: 各スライスは公開 API（index.ts）を通じてのみアクセス
- **相対インポート**: 同一スライス内では相対インポートを使用
- **絶対インポート**: 異なるスライス間では絶対インポートを使用

### FSD 原則

- **低結合・高凝集**: スライスは独立性を保ち、内部は密結合
- **公開 API**: 各スライスは明確な公開 API を定義
- **ビジネス志向**: レイヤーとスライスの名前はビジネス用語を使用
- **段階的導入**: 既存コードからの段階的移行を許容

## 設計原則

- 単一責任の原則を守ってください
- コンポーネントの再利用性を高めてください
- Server Component と Client Component を適切に使い分けてください
- 型安全性を重視し、TypeScript の恩恵を最大限活用してください
- Prisma スキーマを中心としたデータ駆動設計を採用してください
- FSD のレイヤー構造とインポートルールに従ってください

## コード組織

- FSD のレイヤー・スライス・セグメント構造に従って配置してください
- UI コンポーネントとビジネスロジックを分離してください
- Server Actions と API ルートを適切に使い分けてください
- 認証状態の管理は NextAuth.js のセッションを活用してください
- 各スライスには適切な公開 API（index.ts）を作成してください

# テスト方針

## 使用テストフレームワーク

現在、専用のテストフレームワークは設定されていません。

## テスト記述方針（推奨）

- Jest + Testing Library または vitest の導入を検討してください
- コンポーネントの単体テストを作成してください
- Server Actions の統合テストを作成してください
- Prisma スキーマの変更時はデータベーステストを実行してください
- E2E テストとしては、Playwright + Next.js Testing Library の組み合わせを推奨します

## テスト命名規則（推奨）

- テストファイルには `.test.ts` または `.spec.ts` 接尾辞を使用してください
- テストディレクトリは `__tests__/` または各ファイルの隣に配置してください
- コンポーネントテストは対象コンポーネントと同じディレクトリに配置してください

# アンチパターン

## 禁止事項

### TypeScript/JavaScript

- default export は避けて named export を使用してください
- any 型は原則使用しないでください
- var は使用せず、let または const を使用してください
- ==ではなく===を使用してください
- console.log をプロダクションコードに残さないでください

### Next.js App Router

- useRouter を不適切に使用しないでください（Client Component でのみ使用）
- metadata オブジェクトは Server Component でのみエクスポートしてください
- 'use client'ディレクティブを不必要に使用しないでください
- App Router の規約に反するファイル配置をしないでください
- Server Component から Client Component にシリアライズ不可能なプロパティを渡さないでください

### React 19

- useState の不必要な使用を避け、Server Component を優先してください
- useEffect の依存配列を適切に設定してください
- Key の重複や index 使用を避けてください

### Prisma

- N+1 クエリ問題を避けてください（include や select を適切に使用）
- 生の SQL 文字列の結合は避けて、Prisma のクエリビルダーを使用してください
- トランザクションは prisma.$transaction を使用してください
- マイグレーションファイルを手動で編集しないでください

### NextAuth.js v5

- セッション情報を不適切にクライアントに露出しないでください
- 認証状態のチェックをクライアントサイドのみで行わないでください
- JWT シークレットや環境変数をコードに直接記述しないでください

### shadcn/ui

- コンポーネントのカスタマイズ時は、variants API を使用してください
- CSS クラスの直接上書きは避け、Tailwind のユーティリティを使用してください
- shadcn/ui コンポーネントを不適切に改変しないでください

### FSD 関連

- スライス間のクロスインポートは原則禁止です（@x 表記を除く）
- 公開 API を持たないスライスからの直接インポートは避けてください
- 上位レイヤーから下位レイヤー以外のインポートは禁止です
- 同一スライス内でも公開 API を経由せずに../でインポートしないでください
- ワイルドカード（\*）による一括エクスポートは避けて明示的にエクスポートしてください
- エンティティ間の関係は@x 表記を使用して明示してください
- ビジネス用語以外のスライス名（utils、helpers、components 等）は使用しないでください

## コード品質

- 未使用の変数や import は削除してください
- 重複コードは避けて関数化してください
- 適切なエラーハンドリングを実装してください（try-catch、Error Boundary）
- パフォーマンスを考慮したコードを記述してください
- コンポーネントの責務を明確に分離してください

## セキュリティ

- ユーザー入力は必ず Zod で検証してください
- 環境変数を.env ファイルで管理し、機密情報をコードに直接記述しないでください
- NextAuth.js の認証・認可を適切に実装してください
- CSRF や XSS 対策を考慮してください
- データベースクエリでは常に Prisma のパラメータ化クエリを使用してください
