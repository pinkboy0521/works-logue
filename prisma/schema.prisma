generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String           @id @default(cuid())
  email                      String?
  image                      String?
  role                       UserRole         @default(USER)
  displayName                String?
  userId                     String?          @unique
  bio                        String?
  website                    String?
  location                   String?
  statusMessage              String?
  emailVerified              Boolean          @default(false)
  createdAt                  DateTime         @default(now())
  updatedAt                  DateTime         @updatedAt
  emailVerificationExpiresAt DateTime?
  emailVerificationToken     String?
  accounts                   Account[]
  articles                   Article[]
  userOccupations            UserOccupation[]
  userSkills                 UserSkill[]
  comments                   Comment[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  access_token      String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Article {
  id          String        @id @default(cuid())
  userId      String
  title       String
  topImageUrl String?
  status      ArticleStatus @default(DRAFT)
  publishedAt DateTime?
  viewCount   Int           @default(0)
  likeCount   Int           @default(0)
  topicId     String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  content     Json?
  topic       Topic?        @relation(fields: [topicId], references: [id])
  user        User          @relation(fields: [userId], references: [id])
  tags        ArticleTag[]
  comments    Comment[]

  @@index([userId])
  @@index([status, publishedAt])
  @@index([topicId])
}

model Comment {
  id        String    @id @default(cuid())
  content   String
  articleId String
  userId    String
  parentId  String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  article   Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  user      User      @relation(fields: [userId], references: [id])

  @@index([articleId, isDeleted, createdAt])
  @@index([parentId])
  @@index([userId])
  @@map("comments")
}

model SkillCategory {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  skills      Skill[]
}

model Skill {
  id          String        @id @default(cuid())
  name        String        @unique
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  categoryId  String
  category    SkillCategory @relation(fields: [categoryId], references: [id])
  userSkills  UserSkill[]

  @@index([categoryId])
}

model UserSkill {
  userId    String
  skillId   String
  createdAt DateTime @default(now())
  skill     Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, skillId])
}

model OccupationCategory {
  id          String       @id @default(cuid())
  key         String       @unique
  name        String
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  occupations Occupation[]
}

model Occupation {
  id              String             @id @default(cuid())
  name            String             @unique
  description     String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  categoryId      String
  category        OccupationCategory @relation(fields: [categoryId], references: [id])
  userOccupations UserOccupation[]

  @@index([categoryId])
}

model UserOccupation {
  userId       String
  occupationId String
  createdAt    DateTime   @default(now())
  occupation   Occupation @relation(fields: [occupationId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, occupationId])
}

model Topic {
  id          String    @id @default(cuid())
  name        String    @unique
  description String
  articles    Article[]
}

enum TagTaxonomyType {
  INDUSTRY
  JOB_CATEGORY
  POSITION
  SITUATION
  SKILL_KNOWLEDGE
}

model Tag {
  id           String          @id @default(cuid())
  name         String          @unique
  description  String
  
  // 階層構造
  parentId     String?
  parent       Tag?            @relation("TagHierarchy", fields: [parentId], references: [id])
  children     Tag[]           @relation("TagHierarchy")
  level        Int             // 1=業界, 2=サブ業界, 3=詳細
  
  // タグ種別
  taxonomyType TagTaxonomyType // INDUSTRY, JOB_CATEGORY, POSITION, SITUATION, SKILL_KNOWLEDGE
  
  // 表示制御
  sortOrder    Int             @default(0)
  
  articles     ArticleTag[]
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  
  @@index([parentId])
  @@index([taxonomyType, level, sortOrder])
}

model ArticleTag {
  articleId String
  tagId     String
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@id([articleId, tagId])
  @@index([tagId, articleId]) // タグ→記事方向の検索最適化
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  PRIVATE
}

enum UserRole {
  USER
  ADMIN
}
